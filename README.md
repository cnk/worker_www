# Page rules written as a Cloudflare Worker

This project was initially generated using the
[worker-typescript-template](https://github.com/cloudflare/worker-typescript-template).
I have subsequently copied some of the module code and config files from the
[miniflare-typescript-esbuild-jest
repository](https://github.com/mrbbot/miniflare-typescript-esbuild-jest) so I
could use some of miniflare's support for parts of the Cloudflare stack. In
particular, I am interested in having an in memory cache (or a mock cache) so I
can test my caching handlers.

### 👩 💻 Developing

```shell
# Install dependencies
$ npm install
# Format and lint (from the original template)
$ npm run format # uses prettier
$ npm run lint  # Lint complains eslint does not officially support my version of typescript
# Run type checking
$ npm run types:check
```

To start the miniflare environment in debug mode, run the following:

```shell
miniflare --debug --upstream https://example.com/ dist/index.mjs
```

### 🧪 Testing

This template comes with jest tests which simply test that the request handler
can handle each request method. `npm test` will run your tests. The npm test
script was defined as `jest --config jest.config.js --verbose` in the
package.json generated by the worker-typescript-template. That still works -
with the exception that I haven't figured out how to insert the cache into my
tests.

```
  ● handle › handle GET

    TypeError: Cannot read properties of undefined (reading 'match')

      46 |   // if not, you will need to fetch it from origin, and store it in the cache
      47 |   // for future access
    > 48 |   const response = await cache.match(cacheKey)
         |                                ^
      49 |
      50 |   console.log(response)
      51 |

      at defaultCacheStrategy (src/handler.ts:48:32)
      at Object.<anonymous> (test/handlers.test.ts:22:46)
```


I tried changing this to the version of the test script from the miniflare
example project: `npm run build && node --experimental-vm-modules
node_modules/jest/bin/jest.js` but then I can't get my tests to run at all. The
build part of it works if called separately so it must be the node command that
isn't working.

```
 FAIL  test/helpers.test.ts
  ● Test suite failed to run

    ReferenceError: exports is not defined

      3 |
      4 | declare var global: any
    > 5 |
        | ^
      6 | describe('responseCachable', () => {
      7 |   test('responses are not cacheable by default', () => {
      8 |     const response = new Response('throwaway body', {

      at test/helpers.test.ts:5:23

 FAIL  test/handlers.test.ts
  ● Test suite failed to run

    ReferenceError: exports is not defined

      3 | import { Cache } from '@miniflare/cache'
      4 | import { MemoryStorage } from '@miniflare/storage-memory'
    > 5 |
        | ^
      6 | declare var global: any
      7 |
      8 | describe('handle', () => {

      at test/handlers.test.ts:5:23
```